/*
C0GGGCfttfttt;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;i;iiiiiiiiiiiiiiii
.....,LfffLGCfttttttttttttttttttttLfLCLi,.......1;t.......,,,,,,,....,,,,,,,............
.....,ffttf,..:f0000CfttttffLCCLft,1fLL ;Lf:tLt1LfL;t;;;;;;;iiiiii11111111111111111111111
......tfttf,.......:11itL1i1tLLLLLLLLLLLLLLLLtf:,tLLLLLtfi;iiiiiiiii11ii11111iii1i1111111
......1ittf,....fttLLt1tt1LftLLLLLLLLLLLLf::LLt1Lt1LL:LLLLLf11................
......ii;tf,..LtCCttLLLLLLftLttLLLLLLLLLLLLLLLLf1ft1tt1t1111tttti,...............
......ii;;f,.fCftLLLLLLLLLLL1fLtLLLLLLLCCfffffLCCtfftfttt1tt1tttt1t1i...............
......ii;;i,.ffLLLLLLLLLLLLLLttCfCCffffCLLLf1t111t1tftLLLLLLLLLLLLttCff,.................
......ii;;i,.CCCCCCCCCCCCCfi;it1f1LCCCftttLLLLLLLLLttftLLLLLLLLLLLL1tLftfL...............
......ii;;i,.LCCCCCf:;;LGCCCCLLt1ttffCCCCCCLLLLLLLLLtfttLLLLLLLLLLLL11LftfLLL............
......ii;;i,.::t.;;LLi;;;;;;;;;;;;;;;i;;;;;;LCCLLLLLLtLttLLLLLCCCCCCCtfCLfCCCLL..........
......ii;;i:,.,;:i::;;;;;::..........,..,;;;;;;iCCCLLftLtLCCCCCCCCCCCCttCffCCCCC.........
......ii;i,.:...:.........................i...::;;;1CCffLtLCCfffffftttf11LttLffff........
......i1..,...1....  ...... ........,......,.......,;;;;;iffftLCCCCCLfft1tt1tttfffL......
.....;.,.... ,..... ;...... ........i......:.............:;i;;iLfttfCCCCftCffCCCCCCC.....
;;.:.ii............,....... ........:.......;..............i.;,:;;tGCCCCCfLCtLCCCCCCf....
ft :L1,... ................ ........:.......:........ .i..  ;.;:tf,:;GCCCffCtfCCCCCCC....
.t,CCi....;.......,........ ........;........;..  .... .,...fff,.....;;CCCtCCtCCCCCCCi...
tLG;i.,.., .......1........ . .....:;........i:.............;Lffftii1.ii;CtfGffCCCCCCL...
tCG; :.. ,   .....1    ....  ......i:;.......;:..........i...ti. .....:;t;1fCffCCCCCC;...
tCG,.i............i.. ............,i.::......,.i:......;,,...,i. ....i t:t;;;ffCCCCC:....
tCG.;:..i.........; .......:......:i .i......, ,1,..,:.:,.;...;.:....1.ti.1f;;;,......,::
tC,.;...:....:....;........t......;;. :1.....,..:i......i.i...i.;....;,;1..;;;;tft1iii;;;
tC.,t...:....t,...:1.....:.,:.....;:. .:....., ,,;;.....;,:...;.,....;:.:..,t::Lftt;;f;;t
tC.;t...;....t.....:,....::.:.....1:,  ,i....:   ,;;....;:,;.,:.,...11;....:t.,Ltttt1,;f,
t1.it...;....,....,i::...::.;i....i:,  .,;..,;  .,.,:...:;,:.,,.:...;1;,.......ftt1;i:1,i
t:.1;...;.....:....;:i:,.;:..:;...:;,.  ,:..,.   .  :C1..,,,....;...i1t:.......ftt1,:1i.1
f,.ti...1;....;....,:.;::.:. .,....,,.  ,,:,,.      .GL..,,,:...i,.1tft;.......ttt11i,,L.
t,.;;...;;,...:;...:;. :::,,. .....,.. ..,,,,        GG.......:,,..;;fti,......1tt1,:1;,1
f:;;t...;i;....1,...;:...,:GG      .... .,,..       .iG1     .,i..i;,;;t:......itt1;i,t,i
ffLft1,.:;i;...,;,..;::.....G .          ..,         .GG     .,.i.;;,t;t;......itt1t1111t
fCG. t:..i;;;,..1;i..:.,.  .GG           . .       ...G0..  .,;,:;i;1t;;;......1ftt  f. t
fCGfft::.:i;i;;..i::.:...   .G:          ..      ...........::,t;i;fiLi;;......1fttff tt,
fCGLLtt;,,1;11;;..i::;:.    .;G......          ..............;;;1i:iiL;;;......tfftLfffff
fC0  tt;;.tt;;i;;;,;;;::.. ...GG..........     ............,,11;;;.;if;;;:..:..1LLf;:,,,.
fC0  tti;;it11t;i;;1;i:;f.......,........       ..........,.:;;if;.;it;;;;..i..,
fC0  t;;t;iL;1t;;i;;1;;;1i............ .          .........it;i;i:.;i1;;;;..i....
LG0  f;;;1;t;11;;;fi;i;;ttf..........                   ..Li;;11;..,ii;;;;,.1...:
LG0  i;;;11i;t;;;;1;;1t;iLii,....         ,1iL         .:iit:;;1;...i;;;;;;.;...i
CCGi1;;;;ifi;t,;;;;;i;;;ifiiiG..                    .,tCiii::1i1:...i;;;;;;.i....
GGGG1;;;;it;;t.;;;;;i;;,;tiiiii1it;. .          ..:;:::tiii.:11i:...t;;;;;;.i.....
,,,,;;;1;tt;tt.;;;;;;;;.iiiiiiifiiiiiiiit1;...,G:::::::tii1.11ii,...1;i;;;;;;,...i.......
...i;;;;ttf;;1.;;;;i:;..tiiiii11iiiiiiiGCGGGGGGGGGGGGGGG0i1.itii....,;f;;;;;;;...........
..:;;;1;ttf;i;,;;;;i::..1i;iiitiiiiiiifGGGGGGGGGGGGGGGGGLi;1i1ii.....;i;;;;;;i....;.....C
..;;;;;Lffi11,;;;;i1:...G:;f1ii1fL::::G000GGGGGGGGGGG000;;,1iiii.... f;;;;;;;t....;111i;C
,1;;;t1fff;Lt.;;;;Lf,...G:,,,,,,,,,,,,fGGGGGGGGGGGGGG00G::i::::f.....1;1;;;;;;.... 111ttL
:;;;;;0000;Gi.;;;:,:...tG,,,,,,,,,,,,,,GGGGGGGGGGGGG00,,,:1:::::1....1:tft1;;;:....f:::;i
;;;;tt,,,it, .;;1,,,...CG,,,,,,,,,,,,,,L00GGGGGGGGG0,,,,,,:,,,:,1....t;LLLC8L;t....;:::::
;;;i1,,.,t,;.;;L,:, ..,GGt,.........f...GGGGGGGCCC.     .,,    ,:....1CLLG:,  i.....1::::
;;;i.,.,,1,..;1,,,;...t;;................CCCCCCC.  ;..........;;:....tCLG,    .:....t::::
;;f:,,,,,i; .;.,,,t..;G:..............:;i.CCCC i:...............i;...itL.   ;  :....;1:,:
;tt,,,,,t,..;:;:,:1..fG...,;iiii11111t,i1.;Lti:;iii;,...........t:...;i    .    :....iii;
;i,,,,,,1; .1.:1,1,.;GC..,::;iiii1i1iii,,:.t1;itt1i11ii;:......::f;.,;;          ....i1,:
t,,,,,,;,..: ,,,:i.;GCi.........,;;111f1ii11...1i;..,:;;:,....,::LC.,;;          ;...;;,,
,,,,,,,ii .1 ,,,1;;GLf;,..........i11,i000f:i:...............,;.LLC;:;1,    ...  ,....i1,
,,,,,,i, .,  ,,,iiGLL 1::........;i1.i00000i.1;..,;.........:i,LLLtf;;t   ,,,,    ....;;:
::,,:::; ... ,,,;:LLL  ii1ft1111ti;.;f0;10Gt..t:..111t;...;ii,tLL0,:;;1 :i;,i.    1...;i1
11tttff .i , ,;;:1LLL  ft11t,,. ;:..;CG0GtLG..ii...,i1111f11t.LLL:,:;;i:::::    t:;....;.
,,,,:, .,.,, ,fL;iLLL    ..    ::..,;GGGGiLL...1;..i ,11ti,.,CLLL:1 ;it,::     i1CC:...;:
,,,,,,..1.,,.,:111LLL         L:...::GGGG:CL1..1i...  ....   LLL::: i1;:.      :fL1C...:;
,,,:t .; ,,,,,,i::CCC        C;....::GGGG::CC..;;....       CLLLii,:1t,    .....L1i:....;
:,:i .;:.,,,,,,i;1CCC       C1....:.1GGG;  CC;.;,...i       CCC,:i,i11.,,,,,....1f1ti...;
,:: .;t ,,,,,::1;1GCC      Cf.....;,C:LG,..iC1.i....1     .CCCt::f, i;,,,,,,,,;1;:LCC...,
*/


#pragma once

#include "my.h"

#define local static

#define BASE 65521UL    /* largest prime smaller than 65536 */
#define NMAX 5552
/* NMAX is the largest n such that 255n(n+1)/2 + (n+1)(BASE-1) <= 2^32-1 */

#define DO1(buf,i)  {adler += (buf)[i]; sum2 += adler;}
#define DO2(buf,i)  DO1(buf,i); DO1(buf,i+1);
#define DO4(buf,i)  DO2(buf,i); DO2(buf,i+2);
#define DO8(buf,i)  DO4(buf,i); DO4(buf,i+4);
#define DO16(buf)   DO8(buf,0); DO8(buf,8);

#  define MOD(a) a %= BASE
#  define MOD4(a) a %= BASE

/* ========================================================================= */
ULONG adler32IStream(ULONG adler, IStream *Stream, ULARGE_INTEGER len)
{
	unsigned long sum2;
	unsigned n;

	Byte    buffer[16];

	/* split Adler-32 into component sums */
	sum2 = (adler >> 16) & 0xffff;
	adler &= 0xffff;

	/* in case user likes doing a byte at a time, keep it fast */
	if (len.QuadPart == 1) {
		Stream->Read(buffer, 1, NULL);
		adler += buffer[0];
		if (adler >= BASE)
			adler -= BASE;
		sum2 += adler;
		if (sum2 >= BASE)
			sum2 -= BASE;
		return adler | (sum2 << 16);
	}

	/* initial Adler-32 value (deferred check for len == 1 speed) */
	if (Stream == NULL)
		return 1L;

	/* in case short lengths are provided, keep it somewhat fast */
	if (len.QuadPart < 16) {
		while (len.QuadPart--)
		{
			Stream->Read(buffer, 1, NULL);
			adler += buffer[0];
			sum2 += adler;
		}
		if (adler >= BASE)
			adler -= BASE;
		MOD4(sum2);             /* only added so many BASE's */
		return adler | (sum2 << 16);
	}

	/* do length NMAX blocks -- requires just one modulo operation */
	while (len.QuadPart >= NMAX) {
		len.QuadPart -= NMAX;
		n = NMAX / 16;          /* NMAX is divisible by 16 */
		do {
			Stream->Read(buffer, 16, NULL);
			DO16(buffer);          /* 16 sums unrolled */
		} while (--n);
		MOD(adler);
		MOD(sum2);
	}

	/* do remaining bytes (less than NMAX, still just one modulo) */
	if (len.QuadPart) {                  /* avoid modulos if none remaining */
		while (len.QuadPart >= 16) {
			len.QuadPart -= 16;
			Stream->Read(buffer, 16, NULL);
			DO16(buffer);
		}
		while (len.QuadPart--) {
			Stream->Read(buffer, 1, NULL);
			adler += buffer[0];
			sum2 += adler;
		}
		MOD(adler);
		MOD(sum2);
	}

	/* return recombined sums */
	return adler | (sum2 << 16);
}
